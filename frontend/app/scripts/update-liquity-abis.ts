import { $ } from "dax-sh";
import * as fs from "node:fs/promises";
import * as path from "path";
import * as v from "valibot";

const dirname = path.dirname(new URL(import.meta.url).pathname);

const rootDir = path.resolve(`${dirname}/../../..`);

const appDir = `${rootDir}/frontend/app`;
const contractsDir = `${rootDir}/contracts`;
const artifactsTmpDir = `${appDir}/liquity-artifacts`;
const appAbisDir = `${appDir}/src/abi`;

// The first name is the contract ABI used in the app,
// the rest are possible names of the contract in the artifacts.
const ABIS = [
  // Protocol
  ["CollateralRegistry"],
  ["HintHelpers"],
  ["MultiTroveGetter"],

  // Collaterals
  ["ActivePool"],
  ["BorrowerOperations"],
  ["CollSurplusPool"],
  ["DefaultPool"],
  ["GasPool"],
  ["PriceFeed", "PriceFeedTestNet", "PriceFeedMock"],
  ["SortedTroves"],
  ["StabilityPool"],
  ["TroveManager"],
];

const ArtifactSchema = v.object({
  abi: v.array(v.unknown()),
});

async function writeAbiFromArtifact(artifactPath: string, abiName: string) {
  const json = await fs.readFile(artifactPath, "utf-8");
  const artifact = v.parse(ArtifactSchema, JSON.parse(json));

  const tsFileContent = [
    "// this file was generated by scripts/update-liquity-abis.ts",
    "// please do not edit it manually",
    `export const ${abiName} = ${JSON.stringify(artifact.abi)} as const;`,
  ].join("\n");

  await fs.writeFile(`${appAbisDir}/${abiName}.ts`, tsFileContent);
  await $`dprint --log-level silent fmt ${appAbisDir}/${abiName}.ts`;
}

async function main() {
  console.log("ðŸ‘‰ Building Liquity contractsâ€¦\n");
  await $`forge build --root ${contractsDir} --out ${artifactsTmpDir}`;

  console.log("ðŸ‘‰ Building promisesâ€¦");
  await Promise.all(ABIS.map(async (possibleNames) => {
    const abiName = possibleNames[0];

    let foundAbiName: string | null = null;
    for (const possibleName of possibleNames) {
      try {
        await fs.access(`${artifactsTmpDir}/${possibleName}.sol/${possibleName}.json`);
        foundAbiName = possibleName;
        break;
      } catch (_) {}
    }

    if (!foundAbiName) {
      throw new Error(`Could not find ABI for ${possibleNames.join(", ")}`);
    }

    return (
      writeAbiFromArtifact(
        `${artifactsTmpDir}/${foundAbiName}.sol/${foundAbiName}.json`,
        abiName,
      )
    );
  }));

  console.log("ðŸ‘‰ Removing temporary artifactsâ€¦");
  await $`rm -rf ${artifactsTmpDir}`;
  console.log("\nDone.");
  console.log("");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
